<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NIET Student Check-In</title>
<style>
  :root{
    --brand:#704E9A;
    --brand-dark:#5c3c81;
    --ok:#118a0a; --warn:#d97706; --err:#b91c1c;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;}
  body{
    margin:0;color:#111;
    background:linear-gradient(135deg,#704E9A 0%,#5563DE 100%);
    min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
  }
  .wrap{width:100%;max-width:600px;}
  .card{
    background:#fff;border-radius:20px;padding:40px 28px;
    box-shadow:0 18px 40px rgba(0,0,0,.15);
  }
  h1{
    margin:0 0 14px;font-size:28px;text-align:center;
    background:linear-gradient(90deg,#704E9A,#5563DE);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    font-weight:800;
  }
  .muted{color:#555;font-size:14px;margin:0 0 20px;text-align:center;}
  label{display:block;margin:14px 0 8px;font-weight:600;}
  input,select,button{
    width:100%;padding:14px 16px;border:1px solid #d8dee9;border-radius:12px;background:#fff;font-size:16px;
  }
  input:focus,select:focus{
    outline:none;border-color:var(--brand);
    box-shadow:0 0 0 4px rgba(112,78,154,.10);
  }
  button{
    background:var(--brand);color:#fff;border:none;font-weight:700;margin-top:20px;cursor:pointer;
    transition:background .2s ease;font-size:16px;padding:14px;
  }
  button:hover:not([disabled]){background:var(--brand-dark);}
  button[disabled]{background:#d5cce3;cursor:not-allowed;}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  .msg{margin-top:16px;padding:14px;border-radius:12px;font-size:15px;display:none;}
  .msg.ok{display:block;background:#ecfdf5;color:var(--ok);border:1px solid #bbf7d0;}
  .msg.warn{display:block;background:#fffbeb;color:var(--warn);border:1px solid #fde68a;}
  .msg.err{display:block;background:#fef2f2;color:var(--err);border:1px solid #fecaca;}
  .footer{text-align:center;margin-top:18px;color:#6b7280;font-size:12px;}
  .checkout-section{margin-top:24px;padding-top:24px;border-top:2px solid #e5e7eb;}
  .status-badge{display:inline-block;padding:6px 12px;border-radius:8px;font-size:13px;font-weight:600;margin-bottom:12px;}
  .status-badge.active{background:#d1fae5;color:#065f46;}
  .time-display{font-size:14px;color:#6b7280;margin:8px 0;}
  .checkout-btn{background:#059669;margin-top:12px;}
  .checkout-btn:hover:not([disabled]){background:#047857;}
  #checkInSection.hidden, #checkoutSection.hidden{display:none;}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Student Attendance Check-In</h1>
      <p class="muted">Please allow location. Your GPS is used only to verify you are on campus.</p>

      <div id="checkInSection">
      <form onsubmit="submitForm(); return false;">
        <label for="studentId">Student ID</label>
        <input id="studentId" inputmode="numeric" pattern="[0-9]*" placeholder="e.g. 13579666" required autofocus />

        <label for="name">Full Name</label>
        <input id="name" placeholder="e.g. Wilson So" required />

        <div class="row">
          <div>
            <label for="trainer">Trainer</label>
            <select id="trainer" required>
              <option value="">— Select trainer —</option>
            </select>
          </div>
          <div>
            <label for="course">Course</label>
            <select id="course" required>
              <option value="">— Select course —</option>
            </select>
          </div>
        </div>

        <button id="btn" disabled>Check In</button>
      </form>
      </div>

      <div id="checkoutSection" class="checkout-section hidden">
        <span class="status-badge active">✓ Checked In</span>
        <div class="time-display" id="checkInTime"></div>
        <div class="time-display" id="elapsedTime"></div>

        <label for="checkoutStudentId">Student ID to Check Out</label>
        <input id="checkoutStudentId" inputmode="numeric" pattern="[0-9]*" placeholder="e.g. 13579666" />

        <button id="checkoutBtn" class="checkout-btn" onclick="submitCheckout(); return false;">Check Out</button>
      </div>

      <div id="msg" class="msg"></div>
      <div class="footer">© NIET Attendance</div>
    </div>
  </div>

<script>
/* CONFIG */
const FLOW_URL = "https://default9d8868a5c1dc4786aff1f7d04646be.9a.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/9ed041ac7ca143a0b262334d9dfc13d5/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=il-cX-qHDZbGSxE2OnN56BK2jdJIgxWXFIStUm65G6g";const ID_REGEX = /^[0-9]{8,}$/;

/* All available courses */
const ALL_COURSES = [
  "BSB40120 Certificate IV in Business",
  "BSB50120 Diploma of Business UniTrack",
  "BSB50420 Diploma of Leadership and Management",
  "BSB80120 Graduate Diploma of Management (Learning) UniTrack",
  "SIT30821 Certificate III in Commercial Cookery",
  "SIT40521 Certificate IV in Kitchen Management",
  "SIT50422 Diploma of Hospitality Management",
  "ICT50220 Diploma of Information Technology",
  "ICT60220 Advanced Diploma of Information Technology (Telecommunications Network Engineering)",
  "CHC43015 Certificate IV in Ageing Support",
  "CHC33021 Certificate III in Individual Support",
  "CHC52021 Diploma of Community Services",
  "CHC30121 Certificate III in Early Childhood Education and Care",
  "CHC50121 Diploma of Early Childhood Education and Care",
  "HLT52021 Diploma of Remedial Massage"
];

/* Trainers and their courses */
const TRAINER_COURSES = {
  "Carlos Castellano": [
    "SIT30821 Certificate III in Commercial Cookery"
  ],
  "Richard LIM": [
    "BSB80120 Graduate Diploma of Management (Learning) UniTrack",
  ],
  "Toriqul Mozumder": [
    "CHC33021 Certificate III in Individual Support",
    "CHC52021 Diploma of Community Services"
  ],

  "Carol Ly": [
    "CHC43015 Certificate IV in Ageing Support",
  ],
  "Marc Bishop": [
    "SIT40521 Certificate IV in Kitchen Management",
  ],
  "Matthew Facey": [
    "BSB50420 Diploma of Leadership and Management",
  ],
  "Ruying Shao": [
    "SIT50422 Diploma of Hospitality Management"
  ],

  "Sherwin Thiarhia": [
    "CHC33021 Certificate III in Individual Support",
    "CHC43015 Certificate IV in Ageing Support",
  ],
  "John Black": [
    "SIT30821 Certificate III in Commercial Cookery",
    "SIT40521 Certificate IV in Kitchen Management",
  ],
  "John Owen": [
    "SIT50422 Diploma of Hospitality Management",
  ],

  "Nicole Hicks": [
    "CHC30121 Certificate III in Early Childhood Education and Care",
    "CHC50121 Diploma of Early Childhood Education and Care"
  ],
  "Niral Joshi": [
    "BSB50120 Diploma of Business UniTrack",
    "BSB80120 Graduate Diploma of Management (Learning) UniTrack"
  ],
  "Tanya Caterson": [
    "SIT30821 Certificate III in Commercial Cookery",
  ],
  "Zeyun Kylie MA": [
    "BSB50420 Diploma of Leadership and Management",
  ],

  "Fei Yu": [
    "CHC50121 Diploma of Early Childhood Education and Care"
  ],

  "Chloe BIAN": [
  "CHC50121 Diploma of Early Childhood Education and Care",
  "CHC30121 Certificate III in Early Childhood Education and Care"
],
  "Edwin Zywko-Hicks": [
  "BSB80120 Graduate Diploma of Management (Learning) UniTrack"
],
  "Gunther Zywko-Hicks": [
  "SIT50422 Diploma of Hospitality Management"
],
  "Jan Cisler": [
  "HLT52021 Diploma of Remedial Massage"
],
  "Li Tang": [
  "CHC30121 Certificate III in Early Childhood Education and Care"
],
  "Marty Gray": [
  "BSB50120 Diploma of Business UniTrack",
  "BSB50420 Diploma of Leadership and Management",
  "BSB80120 Graduate Diploma of Management (Learning) UniTrack"
],
  "Pelin Tatlidil": [
  "ICT50220 Diploma of Information Technology",
],
  "Ranimary": [
  "CHC52021 Diploma of Community Services",
],
  "Robert Sauer": [
  "SIT30821 Certificate III in Commercial Cookery",
  "SIT40521 Certificate IV in Kitchen Management",
],
  "Rona": [
  "SIT30821 Certificate III in Commercial Cookery",
  "SIT40521 Certificate IV in Kitchen Management",
],



  
};

/* Default if trainer not listed */
const OTHER_TRAINERS = [
  "Lily YE","Nati","Peter NG"
];
OTHER_TRAINERS.forEach(t=>TRAINER_COURSES[t]=ALL_COURSES);

/* Campus zones */
const CAMPUS_ZONES = [
  { name:"Brisbane Campus 102 Adelaide Street", lat:-27.468069512085428, lng:153.02471942376695, radius:300 },
  { name:"Brisbane Campus 316 Adelaide Street", lat:-27.465055267670685, lng:153.02871827605486, radius:300 },
  { name:"Gold Coast Campus", lat:-27.945401908916576, lng:153.41147360207012, radius:300 },
  { name:"Hobart Campus", lat:-42.884889723708625, lng:147.32545454150238, radius:300 }
];

/* ELEMENTS */
const elId=document.getElementById('studentId');
const elName=document.getElementById('name');
const elTrainer=document.getElementById('trainer');
const elCourse=document.getElementById('course');
const elBtn=document.getElementById('btn');
const elMsg=document.getElementById('msg');

/* Populate trainers */
(function initDropdowns(){
  Object.keys(TRAINER_COURSES).forEach(t=>{
    const o=document.createElement('option');o.value=t;o.textContent=t;elTrainer.appendChild(o);
  });
})();
elTrainer.addEventListener('change',()=>{
  const courses = TRAINER_COURSES[elTrainer.value] || ALL_COURSES;
  elCourse.innerHTML="";
  ["— Select course —",...courses].forEach((c,i)=>{
    const o=document.createElement('option');o.value=i?c:"";o.textContent=c;elCourse.appendChild(o);
  });
});

/* GPS + once-per-day logic stays unchanged */
let latestLat=null,latestLng=null,gpsReady=false,detectedCampus=null;
function distanceMeters(lat1,lng1,lat2,lng2){
  const toRad=x=>x*Math.PI/180;
  const x=(toRad(lng2-lng1))*Math.cos(toRad((lat1+lat2)/2));
  const y=toRad(lat2-lat1);
  return Math.sqrt(x*x+y*y)*6371000;
}
function detectCampus(lat,lng){
  let best=null;
  for(const c of CAMPUS_ZONES){
    const d=distanceMeters(lat,lng,c.lat,c.lng);
    if(d<=c.radius && (!best||d<best.d))best={...c,d};
  }
  return best;
}
function enableIfReady(){
  const ok=elId.value.trim()&&elName.value.trim()&&elTrainer.value&&elCourse.value&&gpsReady&&ID_REGEX.test(elId.value.trim());
  elBtn.disabled=!ok;
}
['input','change'].forEach(evt=>[elId,elName,elTrainer,elCourse].forEach(el=>el.addEventListener(evt,enableIfReady)));
function startGPS(){
  if(!('geolocation'in navigator)){setMsg('Your device does not support GPS.','err');return;}
  navigator.geolocation.getCurrentPosition(
    pos=>{
      latestLat=pos.coords.latitude;latestLng=pos.coords.longitude;
      detectedCampus=detectCampus(latestLat,latestLng);
      if(!detectedCampus){gpsReady=false;enableIfReady();setMsg('❌ You are not within any campus area.','err');return;}
      gpsReady=true;enableIfReady();
    },
    err=>{
      gpsReady=false;enableIfReady();
      setMsg('⚠️ Location permission is required to check in.','warn');
    },
    {enableHighAccuracy:true,timeout:15000,maximumAge:0}
  );
}
startGPS();

/* LocalStorage helpers for check-in tracking */
function getCheckedInData(id){
  try{
    const key=`checkin_${id}`;
    const data=localStorage.getItem(key);
    return data?JSON.parse(data):null;
  }catch(e){return null;}
}
function saveCheckedInData(id,data){
  try{
    const key=`checkin_${id}`;
    localStorage.setItem(key,JSON.stringify(data));
  }catch(e){}
}
function clearCheckedInData(id){
  try{
    const key=`checkin_${id}`;
    localStorage.removeItem(key);
  }catch(e){}
}
function alreadyCheckedToday(id){
  const data=getCheckedInData(id);
  if(!data)return false;
  const today=new Date().toDateString();
  return new Date(data.timestamp).toDateString()===today;
}
function stampCheckedToday(id,name,trainer,course,campus){
  const data={
    timestamp:new Date().toISOString(),
    name:name,
    trainer:trainer,
    course:course,
    campus:campus
  };
  saveCheckedInData(id,data);
}

/* Checkout elements */
const elCheckoutSection=document.getElementById('checkoutSection');
const elCheckInSection=document.getElementById('checkInSection');
const elCheckoutId=document.getElementById('checkoutStudentId');
const elCheckInTime=document.getElementById('checkInTime');
const elElapsedTime=document.getElementById('elapsedTime');
const elCheckoutBtn=document.getElementById('checkoutBtn');

/* Update UI based on check-in status */
function updateUIForCheckInStatus(){
  const id=(elId.value||'').trim();
  if(!id||!ID_REGEX.test(id)){
    elCheckInSection.classList.remove('hidden');
    elCheckoutSection.classList.add('hidden');
    return;
  }
  const data=getCheckedInData(id);
  if(data&&alreadyCheckedToday(id)){
    elCheckInSection.classList.add('hidden');
    elCheckoutSection.classList.remove('hidden');
    elCheckoutId.value=id;
    const checkInDate=new Date(data.timestamp);
    elCheckInTime.textContent='Check-in time: '+checkInDate.toLocaleTimeString('en-AU');
    updateElapsedTime(data.timestamp);
  }else{
    elCheckInSection.classList.remove('hidden');
    elCheckoutSection.classList.add('hidden');
  }
}

/* Update elapsed time display */
let elapsedInterval=null;
function updateElapsedTime(checkInTimestamp){
  if(elapsedInterval)clearInterval(elapsedInterval);
  function update(){
    const now=new Date();
    const checkIn=new Date(checkInTimestamp);
    const diffMs=now-checkIn;
    const hours=Math.floor(diffMs/3600000);
    const mins=Math.floor((diffMs%3600000)/60000);
    const secs=Math.floor((diffMs%60000)/1000);
    elElapsedTime.textContent=`Time elapsed: ${hours}h ${mins}m ${secs}s`;
  }
  update();
  elapsedInterval=setInterval(update,1000);
}

/* Check UI status on student ID change */
elId.addEventListener('input',updateUIForCheckInStatus);
elId.addEventListener('change',updateUIForCheckInStatus);
updateUIForCheckInStatus();

/* Checkout function */
async function submitCheckout(){
  const id=(elCheckoutId.value||'').trim();
  elMsg.style.display='none';
  if(!ID_REGEX.test(id)){setMsg('Please enter a valid Student ID.','warn');return;}

  const data=getCheckedInData(id);
  if(!data){setMsg('No check-in record found for this ID.','warn');return;}

  const checkInTime=new Date(data.timestamp);
  const checkOutTime=new Date();
  const diffMs=checkOutTime-checkInTime;
  const hours=Math.floor(diffMs/3600000);
  const mins=Math.floor((diffMs%3600000)/60000);
  const totalTimeStr=`${hours}h ${mins}m`;

  elCheckoutBtn.disabled=true;elCheckoutBtn.textContent='Checking out…';
  try{
    const res=await fetch(FLOW_URL,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        StudentID:id,
        Name:data.name,
        Trainer:data.trainer,
        Course:data.course,
        Campus:data.campus,
        CheckInTime:checkInTime.toISOString(),
        CheckOutTime:checkOutTime.toISOString(),
        TotalTime:totalTimeStr,
        Action:'checkout'
      })
    });
    const resData=await res.json().catch(()=>({}));
    if(res.ok){
      setMsg(`✅ Check-out completed! Total time: ${totalTimeStr}`,'ok');
      clearCheckedInData(id);
      if(elapsedInterval)clearInterval(elapsedInterval);
      setTimeout(()=>{
        elCheckInSection.classList.remove('hidden');
        elCheckoutSection.classList.add('hidden');
        elId.value='';elName.value='';elTrainer.value='';elCourse.value='';
        elCheckoutId.value='';
      },2000);
    }else{
      setMsg('❌ '+(resData.message||`Check-out failed (${res.status}).`),'err');
    }
  }catch(e){setMsg('❌ Network error during check-out. Please try again.','err');}
  finally{elCheckoutBtn.disabled=false;elCheckoutBtn.textContent='Check Out';}
}

/* Once-per-day and submit */
function setMsg(text,kind){elMsg.className='msg '+(kind||'ok');elMsg.textContent=text;elMsg.style.display='block';}
async function submitForm(){
  const id=(elId.value||'').trim(),name=(elName.value||'').trim(),trainer=elTrainer.value,course=elCourse.value;
  elMsg.style.display='none';
  if(!ID_REGEX.test(id)){setMsg('Please enter a valid Student ID.','warn');return;}
  if(!gpsReady||latestLat===null||latestLng===null){setMsg('Location not ready. Try again.','warn');startGPS();return;}
  if(!detectedCampus){setMsg('You are not on an NIET campus.','err');return;}
  if(alreadyCheckedToday(id)){setMsg('⚠️ You already checked in today.','warn');return;}

  elBtn.disabled=true;elBtn.textContent='Submitting…';
  try{
    const res=await fetch(FLOW_URL,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({StudentID:id,Name:name,Trainer:trainer,Course:course,Campus:detectedCampus.name,Latitude:latestLat,Longitude:latestLng,Action:'checkin'})
    });
    const data=await res.json().catch(()=>({}));
    if(res.ok){
      setMsg('✅ '+(data.message||'Check-in completed!'),'ok');
      stampCheckedToday(id,name,trainer,course,detectedCampus.name);
      updateUIForCheckInStatus();
    }
    else{setMsg('❌ '+(data.message||`Submission failed (${res.status}).`),'err');}
  }catch(e){setMsg('❌ Network error. Please try again.','err');}
  finally{elBtn.disabled=false;elBtn.textContent='Check In';}
}
</script>
</body>
</html>
